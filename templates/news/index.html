{% extends "base.html" %}
{% load humanize %}
{% block title %}Noticias{% endblock %}

{% block content %}
<section class="section">
  <div class="flex items-center justify-between gap-4">
    <h1 class="h1-glow text-3xl">Noticias</h1>
    <form method="get" class="flex gap-2 items-center">
      <input type="text" name="q" value="{{ query }}" placeholder="Buscar..." class="input" style="min-width:220px">
      <button class="btn-ghost"><i class="fa-solid fa-magnifying-glass mr-2"></i>Buscar</button>
    </form>
  </div>

  <!-- Chips de categorías -->
  <div class="mt-3 flex flex-wrap gap-2">
    <a href="{% url 'news:index' %}" class="tag {% if not current_category %}is-active{% endif %}">Todas</a>
    {% for c in categories %}
      <a href="?categoria={{ c.slug }}" class="tag {% if current_category == c.slug %}is-active{% endif %}" style="--chip: {{ c.color|default:'var(--accent)' }}">
        {% if c.icon %}<i class="{{ c.icon }} mr-1"></i>{% endif %}{{ c.name }}
      </a>
    {% endfor %}
  </div>

  <!-- Destacado -->
  {% if featured %}
    {% with a=featured.0 %}
    <article class="card mt-5 relative overflow-hidden shine-border">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-4">
          <p class="kicker">{% if a.is_patch_notes %}Notas de parche{% else %}Destacado{% endif %}</p>
          <h2 class="text-2xl md:text-3xl font-semibold mb-2">{{ a.title }}</h2>
          <p class="text-white/70 mb-3">{{ a.summary|default_if_none:"" }}</p>
          <p class="text-white/50 text-sm mb-4">
            {% if a.category %}<span class="chip mr-2">{{ a.category.name }}</span>{% endif %}
            <i class="fa-regular fa-clock mr-1"></i>{{ a.publish_at|naturaltime }} · {{ a.reading_time }} min
          </p>
          <a class="lol-button" href="{{ a.get_absolute_url }}">
            <span class="lol-button-text"><i class="fa-solid fa-arrow-right mr-2"></i>Leer</span>
            <span class="lol-button-shine"></span>
          </a>
        </div>
        <div class="relative">
          {% if a.banner_image %}
            <img src="{{ a.banner_image.url }}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:.5rem">
            <div class="floating-orb"></div>
          {% elif a.hero_image %}
            <img src="{{ a.hero_image.url }}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:.5rem">
          {% else %}
            <div class="h-full w-full rounded-lg border border-white/10 flex items-center justify-center text-white/40">Sin imagen</div>
          {% endif %}
        </div>
      </div>
    </article>
    {% endwith %}
  {% endif %}

  <div class="grid md:grid-cols-3 gap-5 mt-5">
    <!-- Columna izquierda: últimas notas de parche -->
    <aside class="card order-last md:order-first">
      <h3 class="card-title"><i class="fa-solid fa-screwdriver-wrench"></i> Notas de parche</h3>
      <ul class="space-y-2">
        {% for p in latest_patch_notes %}
          <li>
            <a class="link-soft" href="{{ p.get_absolute_url }}">
              {% if p.version %}<span class="chip mr-1">{{ p.version }}</span>{% endif %}
              {{ p.title }}
            </a>
          </li>
        {% empty %}
          <li class="text-white/60">—</li>
        {% endfor %}
      </ul>
      <a class="btn-ghost mt-3 inline-block" href="{% url 'news:patch_notes' %}">
        <i class="fa-regular fa-file-lines mr-2"></i>Ver todo
      </a>
    </aside>

    <!-- Listado principal -->
    <section class="md:col-span-2 grid sm:grid-cols-2 gap-5">
      {% for a in page_obj %}
      <article class="card hover-card">
        <a href="{{ a.get_absolute_url }}">
          <div class="aspect-[16/9] overflow-hidden rounded-md border border-white/10 mb-2">
            {% if a.hero_image %}
              <img src="{{ a.hero_image.url }}" alt="" style="width:100%;height:100%;object-fit:cover">
            {% elif a.banner_image %}
              <img src="{{ a.banner_image.url }}" alt="" style="width:100%;height:100%;object-fit:cover">
            {% else %}
              <div class="w-full h-full flex items-center justify-center text-white/30">Sin imagen</div>
            {% endif %}
          </div>
          <h4 class="font-semibold">{{ a.title }}</h4>
          <p class="text-white/60 text-sm mt-1 line-clamp-2">{{ a.summary|default_if_none:"" }}</p>
          <p class="text-white/50 text-xs mt-2">
            {% if a.category %}<span class="chip mr-2">{{ a.category.name }}</span>{% endif %}
            {{ a.publish_at|date:"M d, Y" }} · {{ a.reading_time }} min
          </p>
        </a>
      </article>
      {% empty %}
        <p class="text-white/60">Aún no hay noticias.</p>
      {% endfor %}
    </section>
  </div>

  {% if page_obj.has_other_pages %}
  <nav class="mt-6 flex items-center gap-2">
    {% if page_obj.has_previous %}
      <a class="btn-ghost" href="?page={{ page_obj.previous_page_number }}{% if current_category %}&categoria={{ current_category }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if query %}&q={{ query }}{% endif %}">‹ Anterior</a>
    {% endif %}
    <span class="text-white/60">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="btn-ghost" href="?page={{ page_obj.next_page_number }}{% if current_category %}&categoria={{ current_category }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if query %}&q={{ query }}{% endif %}">Siguiente ›</a>
    {% endif %}
  </nav>
  {% endif %}
</section>

<style>
/* Efectos visuales ligeros */
@keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)}}
.floating-orb{position:absolute;right:-30px;bottom:-30px;width:160px;height:160px;border-radius:100%;
background:radial-gradient(closest-side, rgba(255,255,255,.18), rgba(255,255,255,0));filter:blur(4px);animation:floaty 4s ease-in-out infinite;}
.shine-border{position:relative}
.shine-border::after{content:"";position:absolute;inset:0;border-radius:12px;
background:conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.18), transparent 30%, transparent 70%, rgba(255,255,255,.18));
mask:linear-gradient(#0000, #000, #0000);-webkit-mask:linear-gradient(#0000, #000, #0000);opacity:.6;pointer-events:none}
.hover-card{transition:transform .2s ease, box-shadow .2s ease}
.hover-card:hover{transform:translateY(-3px)}
.tag.is-active{box-shadow:inset 0 0 0 1px var(--accent); color:#fff}
</style>
{% endblock %}
