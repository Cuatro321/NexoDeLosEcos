{% extends "base.html" %}
{% load static %}
{% block title %}{{ item.title }} · Historia{% endblock %}

{% block content %}
<section class="section">

  {# Botón de regreso al Códex #}
  <div class="mb-4">
    <a href="{% url 'codex:index' %}"
       class="btn-ghost inline-flex items-center gap-2 text-sm">
      <i class="fa-solid fa-arrow-left"></i>
      Volver al Códex
    </a>
  </div>

  <article class="lore-shell card">

    <!-- CABECERA -->
    <header class="lore-hero">
      <div>
        <p class="text-xs tracking-[.2em] uppercase text-white/50 mb-1">
          HISTORIA DEL NEXO
        </p>
        <h1 class="h1-glow text-3xl md:text-4xl">{{ item.title }}</h1>

        {% if item.domain %}
          <p class="mt-2 text-sm text-white/70">
            Dominio:
            <a href="{{ item.domain.get_absolute_url }}" class="chip inline-flex items-center gap-2">
              {% if item.domain.icon %}
                <i class="{{ item.domain.icon }}"></i>
              {% else %}
                <i class="fa-solid fa-hourglass-half"></i>
              {% endif %}
              {{ item.domain.name }}
            </a>
          </p>
        {% endif %}
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL (GRID) -->
    <div class="lore-main">
      <!-- Columna izquierda: historia completa -->
      <div class="space-y-4">

        {% if item.cover_image %}
          <figure class="lore-cover">
            <img src="{{ item.cover_image.url }}"
                 alt="Ilustración de {{ item.title }}"
                 loading="lazy" decoding="async">
          </figure>
        {% endif %}

        {% if item.video_url %}
          <video class="lore-video" controls>
            <source src="{{ item.video_url }}" type="video/mp4">
          </video>
        {% endif %}

        <div class="prose prose-invert max-w-none text-white/90">
          {{ item.body|linebreaks }}
        </div>
      </div>

      <!-- Columna derecha: asset destacado + datos -->
      {% if hero_asset or item.domain %}
      <aside class="lore-aside">
        {% if hero_asset %}
          <figure class="lore-aside-media">
            {% if hero_asset.kind == "video" %}
              <video controls>
                <source src="{{ hero_asset.file.url }}">
              </video>
            {% else %}
              <img src="{{ hero_asset.file.url }}"
                   alt="{{ hero_asset.caption|default:item.title }}"
                   loading="lazy" decoding="async">
            {% endif %}
          </figure>
          {% if hero_asset.caption %}
            <p class="mt-2 text-xs text-white/60 uppercase tracking-wide">
              {{ hero_asset.caption }}
            </p>
          {% endif %}
        {% endif %}

        <div class="lore-aside-meta">
          {% if item.domain %}
            <div class="lore-meta-row">
              <span class="lore-meta-label">Dominio</span>
              <a href="{{ item.domain.get_absolute_url }}" class="lore-meta-value">
                {% if item.domain.icon %}
                  <i class="{{ item.domain.icon }} mr-1"></i>
                {% endif %}
                {{ item.domain.name }}
              </a>
            </div>
          {% endif %}

          <div class="lore-meta-row">
            <span class="lore-meta-label">Tipo</span>
            <span class="lore-meta-value">Historia del Códex</span>
          </div>
        </div>
      </aside>
      {% endif %}
    </div>

    <!-- GALERÍA -->
    {% if gallery %}
      <div class="hr-soft my-6"></div>
      <section>
        <h2 class="card-title flex items-center gap-2">
          <i class="fa-solid fa-images"></i> Galería
        </h2>
        <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-4 mt-3">
          {% for a in gallery %}
            {% if a.kind == "video" %}
              <figure class="lore-gallery-item">
                <video controls>
                  <source src="{{ a.file.url }}">
                </video>
                {% if a.caption %}
                  <figcaption>{{ a.caption }}</figcaption>
                {% endif %}
              </figure>
            {% else %}
              <figure class="lore-gallery-item">
                <img src="{{ a.file.url }}"
                     alt="{{ a.caption }}"
                     loading="lazy" decoding="async">
                {% if a.caption %}
                  <figcaption>{{ a.caption }}</figcaption>
                {% endif %}
              </figure>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endif %}

  </article>

</section>

<style>
  .lore-shell{
    padding:1.75rem 1.8rem 2.1rem;
    border-radius:24px;
    background:
      radial-gradient(circle at top left, rgba(59,130,246,.25), transparent 55%),
      radial-gradient(circle at bottom right, rgba(147,51,234,.25), transparent 60%),
      rgba(15,23,42,.96);
    box-shadow:0 28px 60px rgba(0,0,0,.65),
               0 0 0 1px rgba(148,163,184,.35);
  }
  .lore-hero{
    border-bottom:1px solid rgba(148,163,184,.25);
    padding-bottom:1.2rem;
    margin-bottom:1.5rem;
  }
  .lore-main{
    display:grid;
    gap:1.75rem;
  }
  @media (min-width:1024px){
    .lore-main{
      grid-template-columns:minmax(0,2.1fr) minmax(0,1fr);
      align-items:flex-start;
    }
  }
  .lore-cover{
    border-radius:16px;
    overflow:hidden;
    border:1px solid rgba(148,163,184,.35);
  }
  .lore-cover img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .lore-video{
    width:100%;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.35);
    overflow:hidden;
  }
  .lore-aside{
    padding:1rem 1rem 1.2rem;
    border-radius:18px;
    border:1px solid rgba(148,163,184,.3);
    background:radial-gradient(circle at top, rgba(59,130,246,.18), transparent 55%),
               rgba(15,23,42,.95);
  }
  .lore-aside-media{
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(148,163,184,.35);
  }
  .lore-aside-media img,
  .lore-aside-media video{
    width:100%;
    height:100%;
    display:block;
    object-fit:cover;
  }
  .lore-aside-meta{
    margin-top:1rem;
    display:flex;
    flex-direction:column;
    gap:.45rem;
    font-size:.8rem;
  }
  .lore-meta-row{
    display:flex;
    justify-content:space-between;
    gap:.5rem;
  }
  .lore-meta-label{
    text-transform:uppercase;
    letter-spacing:.12em;
    color:rgba(148,163,184,.9);
  }
  .lore-meta-value{
    color:#e5e7eb;
    font-weight:500;
  }
  .lore-gallery-item{
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(148,163,184,.35);
    background:rgba(15,23,42,.9);
  }
  .lore-gallery-item img,
  .lore-gallery-item video{
    width:100%;
    height:190px;
    object-fit:cover;
    display:block;
  }
  .lore-gallery-item figcaption{
    padding:.45rem .6rem .55rem;
    font-size:.8rem;
    color:rgba(226,232,240,.85);
  }
</style>
{% endblock %}
