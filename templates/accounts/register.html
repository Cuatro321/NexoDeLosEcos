{% extends 'base.html' %}
{% load static %}
{% block title %}Crear cuenta · El Nexo de los Ecos{% endblock %}

{% block head %}
<style>
  /* Estructura base con video de fondo */
  .register-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .register-video-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    z-index: -2;
  }

  .register-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.8) 0%,
      rgba(0, 0, 0, 0.6) 50%,
      rgba(0, 0, 0, 0.8) 100%
    );
    z-index: -1;
  }

  /* Partículas decorativas */
  .register-particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
  }

  .register-particle {
    position: absolute;
    background: rgba(var(--accent-rgb), 0.3);
    border-radius: 50%;
    animation: floatRegister 8s infinite ease-in-out;
  }

  @keyframes floatRegister {
    0%, 100% { 
      transform: translateY(0px) rotate(0deg) scale(1);
      opacity: 0.3;
    }
    50% { 
      transform: translateY(-30px) rotate(180deg) scale(1.2);
      opacity: 0.6;
    }
  }

  /* Tarjeta principal con imagen de fondo DENTRO del formulario */
  .register-card {
    background: 
      /* Capa de color semitransparente */
      linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.05) 100%
      ),
      /* Imagen de fondo DENTRO de la card */
      url('{% static "img/fotologin.png" %}') center/cover;
    
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    padding: 3rem;
    box-shadow: 
      0 25px 50px rgba(0, 0, 0, 0.5),
      0 0 100px rgba(var(--accent-rgb), 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: cardEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    max-width: 480px;
    width: 100%;
    min-height: 600px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* Efecto de animación sutil en el fondo de la card */
  .register-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      45deg,
      transparent 0%,
      rgba(255, 255, 255, 0.03) 50%,
      transparent 100%
    );
    animation: bgShine 6s ease-in-out infinite;
    z-index: 1;
    pointer-events: none;
  }

  @keyframes bgShine {
    0%, 100% {
      opacity: 0;
      transform: translateX(-100%);
    }
    50% {
      opacity: 1;
      transform: translateX(100%);
    }
  }

  .register-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.1),
      transparent
    );
    transition: left 0.8s ease;
    z-index: 1;
  }

  .register-card:hover::before {
    left: 100%;
  }

  @keyframes cardEntrance {
    0% {
      opacity: 0;
      transform: translateY(50px) scale(0.9);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Contenido de la card (sobre el fondo de imagen) */
  .register-content {
    position: relative;
    z-index: 2;
  }

  /* Header mejorado */
  .register-header {
    text-align: center;
    margin-bottom: 2.5rem;
    position: relative;
  }

  .register-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--brand), var(--accent));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    animation: iconGlow 3s ease-in-out infinite alternate;
    border: 2px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
  }

  .register-icon::after {
    content: '';
    position: absolute;
    inset: -3px;
    background: linear-gradient(135deg, var(--brand), var(--accent));
    border-radius: 50%;
    z-index: -1;
    filter: blur(15px);
    opacity: 0.5;
  }

  @keyframes iconGlow {
    0% {
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.4);
    }
    100% {
      box-shadow: 0 0 40px rgba(var(--accent-rgb), 0.8);
    }
  }

  /* Formulario mejorado */
  .form-group {
    margin-bottom: 1.5rem;
    position: relative;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
  }

  .input-wrapper {
    position: relative;
    border-radius: 12px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
  }

  .input-wrapper:focus-within {
    border-color: var(--accent);
    box-shadow: 
      0 0 0 3px rgba(var(--accent-rgb), 0.2),
      0 8px 25px rgba(0, 0, 0, 0.4);
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.15);
  }

  .input-wrapper input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    background: transparent;
    border: none;
    color: white;
    font-size: 1rem;
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .input-wrapper input:focus {
    outline: none;
  }

  .input-wrapper input::placeholder {
    color: rgba(255, 255, 255, 0.6);
    text-shadow: none;
  }

  .input-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .input-wrapper:focus-within .input-icon {
    color: var(--accent);
    transform: translateY(-50%) scale(1.1);
    text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
  }

  .password-toggle {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s ease;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .password-toggle:hover {
    color: var(--accent);
    transform: translateY(-50%) scale(1.1);
    text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
  }

  /* Botón de submit mejorado */
  .register-submit {
    width: 100%;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--brand), var(--accent));
    border: none;
    border-radius: 12px;
    color: var(--coal);
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
  }

  .register-submit::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.4),
      transparent
    );
    transition: left 0.6s ease;
  }

  .register-submit:hover::before {
    left: 100%;
  }

  .register-submit:hover {
    transform: translateY(-3px);
    box-shadow: 
      0 15px 30px rgba(var(--accent-rgb), 0.4),
      0 0 30px rgba(var(--accent-rgb), 0.2);
  }

  .register-submit:active {
    transform: translateY(-1px);
  }

  .register-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .register-submit:disabled:hover {
    transform: none;
    box-shadow: none;
  }

  /* Estados de error mejorados */
  .form-error {
    color: #ff6b6b;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: shake 0.5s ease-in-out;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .alert-error {
    background: rgba(255, 107, 107, 0.2);
    border: 1px solid rgba(255, 107, 107, 0.4);
    color: #ff6b6b;
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideDown 0.5s ease-out;
    backdrop-filter: blur(15px);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  @keyframes slideDown {
    0% {
      opacity: 0;
      transform: translateY(-10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Checkbox mejorado */
  .checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    margin-bottom: 1rem;
  }

  .custom-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 4px;
    position: relative;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
  }

  .checkbox-input:checked + .custom-checkbox {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
  }

  .checkbox-input:checked + .custom-checkbox::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--coal);
    font-weight: bold;
    font-size: 0.875rem;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
  }

  .checkbox-label {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    line-height: 1.4;
  }

  /* Enlaces en los checkboxes */
  .link-accent {
    color: var(--accent);
    text-decoration: none;
    transition: all 0.3s ease;
    font-weight: 600;
  }

  .link-accent:hover {
    color: var(--brand);
    text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
  }

  /* Sección de beneficios */
  .benefits-section {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    backdrop-filter: blur(10px);
  }

  .benefits-title {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .benefits-list {
    list-style: none;
    padding: 0;
    margin: 0;
    space-y: 0.75rem;
  }

  .benefit-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
  }

  .benefit-icon {
    color: #10b981;
    font-size: 0.75rem;
  }

  /* Texto de ayuda del formulario */
  .form-help {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Separador */
  .separator {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    margin: 2rem 0;
    position: relative;
  }

  .separator-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: transparent;
    padding: 0 1rem;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.875rem;
    font-weight: 500;
  }

  /* Efectos de texto */
  .text-glow {
    text-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5);
  }

  .fade-in-up {
    animation: fadeInUp 0.8s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 640px) {
    .register-card {
      margin: 1rem;
      padding: 2rem;
      min-height: auto;
    }
    
    .register-icon {
      width: 70px;
      height: 70px;
    }
  }

  /* Estilo para el icono personalizado */
  .register-custom-icon {
    width: 40px;
    height: 40px;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }
</style>
{% endblock %}

{% block content %}
<div class="register-container">
  <!-- Video de fondo general -->
  <video class="register-video-bg" muted loop playsinline
         preload="none"
         poster="{% static 'img/hero-poster.jpg' %}"
         data-src-mp4="{% static 'videos/login.mp4' %}"
         data-src-webm="{% static 'videos/login.webm' %}"
         aria-label="Video de fondo del Nexo de los Ecos">
    <img src="{% static 'img/hero-poster.jpg' %}" alt="Fondo del Nexo de los Ecos">
  </video>

  <div class="register-overlay"></div>
  <div class="register-particles" id="registerParticles"></div>

  <div class="max-w-md w-full mx-4">
    <!-- Tarjeta principal con imagen de fondo DENTRO -->
    <div class="register-card">
      <div class="register-content">
        <!-- Header -->
        <div class="register-header fade-in-up" style="animation-delay: 0.1s">
          <div class="register-icon">
            <img src="{% static 'core/icons/NeoForceGames.png' %}" alt="NeoForce Games" class="register-custom-icon">
          </div>
          <h1 class="h1-glow text-3xl font-bold mb-2 text-glow">Unirse al Nexo</h1>
          <p class="text-white/80 text-lg">
            Comienza tu viaje a través de los dominios
          </p>
        </div>

        <!-- Formulario -->
        <form method="post" class="space-y-6" novalidate id="registerForm">
          {% csrf_token %}
          
          <!-- Errores generales -->
          {% if form.non_field_errors %}
          <div class="alert-error" role="alert">
            <i class="fa-solid fa-circle-exclamation"></i>
            {{ form.non_field_errors.0 }}
          </div>
          {% endif %}

          <!-- Campos del formulario -->
          {% for field in form %}
          <div class="form-group fade-in-up" style="animation-delay: {{ forloop.counter|add:1|divisibleby:10 }}s">
            <label for="{{ field.id_for_label }}" class="form-label">
              {% if field.name == 'username' %}
                <i class="fa-solid fa-user mr-2"></i>
              {% elif field.name == 'email' %}
                <i class="fa-solid fa-envelope mr-2"></i>
              {% elif field.name == 'password1' %}
                <i class="fa-solid fa-lock mr-2"></i>
              {% elif field.name == 'password2' %}
                <i class="fa-solid fa-lock mr-2"></i>
              {% else %}
                <i class="fa-solid fa-pen mr-2"></i>
              {% endif %}
              {{ field.label }}
            </label>
            
            <div class="input-wrapper">
              {{ field }}
              
              {% if field.name == 'username' %}
                <i class="fa-solid fa-user input-icon"></i>
              {% elif field.name == 'email' %}
                <i class="fa-solid fa-envelope input-icon"></i>
              {% elif field.name == 'password1' or field.name == 'password2' %}
                <i class="fa-solid fa-key input-icon"></i>
                <button type="button" class="password-toggle" data-target="{{ field.id_for_label }}">
                  <i class="fa-solid fa-eye"></i>
                </button>
              {% endif %}
            </div>
            
            {% if field.help_text %}
            <div class="form-help">
              <i class="fa-solid fa-circle-info"></i>
              {{ field.help_text }}
            </div>
            {% endif %}
            
            {% if field.errors %}
            <div class="form-error">
              <i class="fa-solid fa-circle-exclamation"></i>
              {{ field.errors.0 }}
            </div>
            {% endif %}
          </div>
          {% endfor %}

          <!-- Términos y condiciones -->
          <div class="checkbox-container fade-in-up" style="animation-delay: 0.6s">
            <input type="checkbox" name="terms" required class="checkbox-input sr-only" id="terms">
            <span class="custom-checkbox"></span>
            <span class="checkbox-label">
              Acepto los 
              <a href="/terms/" class="link-accent">Términos de Servicio</a>
              y la 
              <a href="/privacy/" class="link-accent">Política de Privacidad</a>
            </span>
          </div>

          <!-- Newsletter -->
          <div class="checkbox-container fade-in-up" style="animation-delay: 0.7s">
            <input type="checkbox" name="newsletter" class="checkbox-input sr-only" id="newsletter">
            <span class="custom-checkbox"></span>
            <span class="checkbox-label">
              Recibir notificaciones sobre actualizaciones del Nexo
            </span>
          </div>

          <!-- Submit -->
          <button type="submit" class="register-submit fade-in-up" style="animation-delay: 0.8s" id="submitBtn">
            <span>Crear Cuenta</span>
            <i class="fa-solid fa-sparkles ml-2"></i>
          </button>
        </form>

        <!-- Separador -->
        <div class="separator fade-in-up" style="animation-delay: 0.9s">
          <span class="separator-text">¿Ya tienes una cuenta?</span>
        </div>

        <!-- Enlace a login -->
        <div class="text-center fade-in-up" style="animation-delay: 1s">
          <p class="text-white/70">
            <a href="/accounts/login/" class="link-accent font-semibold text-lg">
              Entrar al Nexo
            </a>
          </p>
        </div>

        <!-- Beneficios -->
        <div class="benefits-section fade-in-up" style="animation-delay: 1.1s">
          <h4 class="benefits-title">
            <i class="fa-solid fa-gift text-accent"></i>
            Al unirte recibes:
          </h4>
          <ul class="benefits-list">
            <li class="benefit-item">
              <i class="fa-solid fa-check benefit-icon"></i>
              Acceso a todos los dominios
            </li>
            <li class="benefit-item">
              <i class="fa-solid fa-check benefit-icon"></i>
              Artefacto de inicio gratuito
            </li>
            <li class="benefit-item">
              <i class="fa-solid fa-check benefit-icon"></i>
              Progreso guardado en la nube
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Cargar video de fondo
  const video = document.querySelector('.register-video-bg');
  if (video) {
    const src = video.dataset.srcMp4;
    if (src && !video.src) {
      video.src = src;
      video.load();
      video.play().catch(e => {
        console.log('Autoplay prevented:', e);
        document.addEventListener('click', function playVideo() {
          video.play();
          document.removeEventListener('click', playVideo);
        });
      });
    }
  }

  // Crear partículas decorativas
  const particlesContainer = document.getElementById('registerParticles');
  if (particlesContainer) {
    const particleCount = 12;
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'register-particle';
      
      const size = Math.random() * 6 + 2;
      const posX = Math.random() * 100;
      const posY = Math.random() * 100;
      const delay = Math.random() * 5;
      const duration = Math.random() * 4 + 6;
      
      particle.style.width = `${size}px`;
      particle.style.height = `${size}px`;
      particle.style.left = `${posX}vw`;
      particle.style.top = `${posY}vh`;
      particle.style.animationDelay = `${delay}s`;
      particle.style.animationDuration = `${duration}s`;
      
      particlesContainer.appendChild(particle);
    }
  }

  // Toggle de visibilidad para contraseñas
  const passwordToggles = document.querySelectorAll('.password-toggle');
  
  passwordToggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const passwordField = document.getElementById(targetId);
      
      if (passwordField) {
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
        
        const icon = this.querySelector('i');
        icon.className = type === 'password' ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash';
      }
    });
  });

  // Validación en tiempo real
  const form = document.getElementById('registerForm');
  const submitBtn = document.getElementById('submitBtn');
  
  if (form) {
    const inputs = form.querySelectorAll('input[required]');
    
    function validateForm() {
      let isValid = true;
      
      inputs.forEach(input => {
        if (!input.value.trim()) {
          isValid = false;
        }
      });
      
      const terms = form.querySelector('input[name="terms"]');
      if (terms && !terms.checked) {
        isValid = false;
      }
      
      submitBtn.disabled = !isValid;
    }
    
    inputs.forEach(input => {
      input.addEventListener('input', validateForm);
      input.addEventListener('change', validateForm);
    });
    
    const termsCheckbox = form.querySelector('input[name="terms"]');
    if (termsCheckbox) {
      termsCheckbox.addEventListener('change', validateForm);
    }
    
    // Validación inicial
    validateForm();
  }

  // Efecto de carga del formulario
  if (form) {
    form.addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Creando cuenta...';
        submitBtn.disabled = true;
      }
    });
  }

  // Efectos de focus mejorados
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    if (input.type !== 'checkbox') {
      input.style.paddingLeft = '3rem';
    }

    input.addEventListener('focus', function() {
      this.parentElement.style.transform = 'translateY(-2px)';
      this.parentElement.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
    });
    
    input.addEventListener('blur', function() {
      this.parentElement.style.transform = 'translateY(0)';
      this.parentElement.style.boxShadow = 'none';
    });

    if (input.value) {
      input.parentElement.classList.add('focused');
    }
  });
});
</script>
{% endblock %}